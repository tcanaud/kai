---
description: Generate corrective tasks from an Agreement check report — translates drift findings into Spec Kit tasks that /speckit.implement can execute.
handoffs:
  - label: Implement fixes
    agent: speckit.implement
    prompt: Execute the corrective tasks in tasks.md
    send: true
  - label: Re-check Agreement
    agent: agreement.check
    prompt: Verify the agreement is now aligned with code
    send: true
---

## User Input

```text
$ARGUMENTS
```

You **MUST** consider the user input before proceeding (if not empty).

## Purpose

Read a check report produced by `/agreement.check`, cross-reference it with the original contracts (source of truth), and generate corrective tasks in the EXACT Spec Kit tasks.md format. The tasks are appended to the existing tasks.md so `/speckit.implement` can process them natively.

## Execution Flow

### 0. Load configuration

Read `.agreements/config.yaml` and extract all paths:
- `speckit_specs_dir` — Spec Kit specs directory (default: "specs")

If `.agreements/config.yaml` does not exist, ERROR "Config not found. Run `npx agreement-system init` first."

All subsequent steps use `speckit_specs_dir` instead of hardcoding "specs".

### 1. Load the check report

**If `$ARGUMENTS` specifies a feature_id** (e.g., "001-bookstore-crud-api"):
- Load `.agreements/{{feature_id}}/check-report.md`
- If not found: ERROR "No check report found. Run `/agreement.check {{feature_id}}` first."

**If `$ARGUMENTS` is empty:**
- Load `.agreements/index.yaml`
- Look for any agreement directory containing a `check-report.md`
- If multiple: ask user to pick one
- If none: ERROR "No check reports found. Run `/agreement.check` first."

### 2. Parse findings

From the check-report.md, extract each finding:
- Finding ID (e.g., FINDING-001)
- Severity (`BREAKING`, `DEGRADATION`, `DRIFT`, `ORPHAN`, `UNTESTED`)
- What the Agreement/contract says (expected behavior)
- What the code does (actual behavior)
- File path to modify
- Contract reference path

**Only process findings with severity `BREAKING` or `DEGRADATION`.**
Skip `DRIFT`, `ORPHAN`, and `UNTESTED` (they don't require code fixes).

### 3. Load the contracts (source of truth)

For each finding, read the referenced contract file to get the EXACT expected behavior:
- Response codes
- Response body structure (exact JSON shape)
- Request validation rules
- Error response format

**CRITICAL**: The contract is the source of truth, NOT the check report summary. The report tells you WHAT is wrong; the contract tells you WHAT IS RIGHT. Always read the full contract section for each finding.

### 4. Load the existing tasks.md

Read `{{speckit_specs_dir}}/{{feature_id}}/tasks.md` to:
- Determine the current highest task ID (e.g., T030)
- Determine the current highest phase number (e.g., Phase 6)
- Understand the naming conventions used in this specific file

### 5. Generate corrective tasks

For each BREAKING/DEGRADATION finding, generate one or more corrective tasks.

#### Task format rules (MUST match Spec Kit exactly)

Each task MUST follow this format:
```
- [ ] TXXX [FIX] Description with exact file path and exact expected behavior
```

Where:
- `TXXX` continues the numbering from the existing tasks (e.g., if last was T030, start at T031)
- `[FIX]` replaces the `[US#]` story marker to identify corrective tasks
- Description MUST include:
  - The exact file path to modify
  - What to change (current behavior → expected behavior)
  - The contract reference for the implementation agent to verify against

#### Task content rules

Each task description MUST be **self-contained** — an implementation agent reading ONLY this task line + the referenced contract MUST be able to make the fix without any other context.

**GOOD task** (self-contained, references contract, specifies exact behavior):
```
- [ ] T031 [FIX] Modify `src/controllers/booksController.js` deleteBook handler: change from `res.json(book)` (200) to `res.status(204).end()` (no body) — ref: contracts/books-api.md DELETE section
```

**BAD task** (vague, no contract reference, no exact behavior):
```
- [ ] T031 [FIX] Fix DELETE response code
```

#### Grouping rules

- If multiple tasks affect the SAME file, they MUST be sequential (not [P])
- If tasks affect DIFFERENT files, mark them [P] for parallel execution
- Always add a final task to update tests to match the corrected behavior
- The test update task depends on all fix tasks and MUST be last

### 6. Write the corrective phase to tasks.md

Append a new phase section at the end of `{{speckit_specs_dir}}/{{feature_id}}/tasks.md` (before the "Dependencies & Execution Order" section if it exists).

The section MUST follow this exact structure:

```markdown
---

## Phase N: Agreement Fixes (auto-generated by /agreement.doctor)

**Source**: .agreements/{{feature_id}}/check-report.md
**Contract reference**: {{speckit_specs_dir}}/{{feature_id}}/contracts/
**Date**: {{date}}
**Policy**: Contract is source of truth — code must align

- [ ] T0XX [FIX] [exact corrective task with file path and expected behavior — ref: contract file]
- [ ] T0XX [P] [FIX] [another task if different file — ref: contract file]
- [ ] T0XX [FIX] Update tests in `tests/integration/[file]` and `tests/unit/[file]` to assert corrected behavior for FIX tasks above

**Checkpoint**: Run `/agreement.check {{feature_id}}` — expected verdict: PASS
```

**IMPORTANT**: If a "Phase N: Agreement Fixes" section already exists in tasks.md, REPLACE it entirely (remove old fix tasks, write new ones). This prevents duplicate fix tasks on re-runs.

### 7. Validate generated tasks

Before writing, verify each generated task against this checklist:

- [ ] Task ID continues from the highest existing ID
- [ ] Task has `[FIX]` marker
- [ ] Task specifies exact file path
- [ ] Task describes current behavior AND expected behavior
- [ ] Task references a contract file path
- [ ] Task is self-contained (readable without other context)
- [ ] Parallel markers [P] are correct (same file = sequential, different files = parallel)
- [ ] A test update task exists as the last task
- [ ] The phase ends with a checkpoint referencing `/agreement.check`

If any task fails this checklist, fix it before writing.

### 8. Report

Display a summary:

```
Agreement Doctor: {{feature_id}}

Findings processed: N (M BREAKING, K DEGRADATION)
Findings skipped: J (DRIFT/ORPHAN/UNTESTED)
Corrective tasks generated: T

Tasks written to: {{speckit_specs_dir}}/{{feature_id}}/tasks.md (Phase N: Agreement Fixes)

Next step:
  /speckit.implement → execute the corrective tasks
  /agreement.check {{feature_id}} → verify PASS after fixes
```

## Rules

- NEVER modify any file other than `{{speckit_specs_dir}}/{{feature_id}}/tasks.md`.
- NEVER modify the Agreement itself — that's `/agreement.sync`'s job.
- NEVER modify contracts — they are the source of truth.
- ALWAYS read the full contract section, not just the check report summary.
- Tasks MUST be self-contained: file path + current behavior + expected behavior + contract reference.
- The `[FIX]` marker is mandatory to distinguish corrective tasks from original implementation tasks.
- If the check report is ambiguous about what the contract expects, read the contract directly.
- On re-run, replace the existing "Agreement Fixes" phase entirely.
