# Research: 007-knowledge-system

**Date**: 2026-02-18
**Branch**: `007-knowledge-system`

## Research Findings

### R1: CLI Architecture Pattern

**Decision**: Follow the established kai CLI pattern — `bin/cli.js` with switch/case router, `src/initializer.js` + `src/updater.js` separation.

**Rationale**: All 5 existing packages (adr-system, agreement-system, feature-lifecycle, mermaid-workbench, tcsetup) use this identical pattern. Consistency is critical for convention conv-002.

**Alternatives considered**:
- Single file CLI: Rejected — doesn't scale with refresh/check subcommands
- Plugin-based architecture: Rejected — over-engineering for a single-purpose tool

### R2: Freshness Detection Mechanism

**Decision**: Use `git log -1 --format=%aI -- <path>` to get last modification date of watched paths. Compare against guide's `last_verified` date in YAML frontmatter.

**Rationale**: Git is a project assumption (ADR: file-based-artifact-tracking). Git log gives accurate last-commit timestamps per file. No external dependencies needed. This mirrors how agreement.check conceptually verifies code against promises.

**Alternatives considered**:
- File system mtime: Rejected — unreliable across clones, CI environments, and after checkout
- Content checksums (sha256): Considered as complement — adds certainty but git timestamps are sufficient for the STALE/VERIFIED binary signal
- inotify/fsevents watchers: Rejected — requires persistent process, violates stateless design

### R3: Index Structure

**Decision**: Flat YAML catalog with sections per source type (guides, conventions, adrs, features). Each entry has id, title, path, summary, topics array. Claude uses semantic matching against titles/summaries/topics.

**Rationale**: Claude doesn't need keyword matching algorithms — it understands natural language. The index serves as a catalog for Claude to route to the right files. Flat structure is easy to generate, parse, and read. Topics provide additional signal for relevance matching.

**Alternatives considered**:
- Inverted keyword index (keyword → artifacts): Rejected — Claude doesn't need programmatic search; it matches semantically
- Graph-based index with relationships: Rejected — over-complex for the routing problem; relationships already captured in guide references
- Embeddings/vector index: Rejected — requires external dependencies, violates zero-deps convention

### R4: Snapshot Generation Strategy

**Decision**: Snapshot is a single Markdown file generated by the CLI (`npx @tcanaud/knowledge-system refresh`). Scanners read each artifact source (conventions from `.agreements/`, ADRs from `.adr/`, features from `.features/`), extract title + status, and write structured sections.

**Rationale**: Reuses the scanner pattern from feature-lifecycle. Deterministic (same inputs → same output), testable, no AI needed. Markdown format is human-readable and AI-parseable.

**Alternatives considered**:
- AI-generated snapshot (Claude summarizes): Rejected — non-deterministic, expensive, requires AI invocation for a mechanical task
- JSON snapshot: Rejected — less human-readable; snapshot should be readable by humans in PRs
- Multiple snapshot files: Rejected — one file is simpler, snapshot is already small

### R5: CLI vs Claude Code Command Boundary

**Decision**: Deterministic operations (init, update, refresh, check) are CLI commands in the package. AI-dependent operations (query `/k`, guide creation `/knowledge.create`) are Claude Code slash commands.

**Rationale**: CLI commands are testable, reproducible, and don't require AI access. Slash commands leverage Claude's natural language understanding where it adds value. This follows the established kai pattern — package CLIs handle scaffolding and data generation; Claude commands handle interactive workflows.

**CLI subcommands**:
- `init` — scaffold .knowledge/ directory
- `update` — refresh command templates
- `refresh` — regenerate snapshot.md + rebuild index.yaml
- `check` — verify all guides freshness, output report to stdout

**Claude Code commands**:
- `/k` — semantic query, reads index, assembles verified answers
- `/knowledge.refresh` — wrapper that calls `npx @tcanaud/knowledge-system refresh`
- `/knowledge.check` — wrapper that calls `npx @tcanaud/knowledge-system check` + interprets results
- `/knowledge.create` — AI-guided guide creation with proper frontmatter

### R6: YAML Parsing Approach

**Decision**: Regex-based frontmatter extraction, same as all other kai packages. No YAML parser library.

**Rationale**: Convention conv-001 (zero runtime deps). All existing packages use regex to extract YAML frontmatter from markdown and simple key-value pairs from YAML configs. The data structures are flat enough that regex works reliably.

**Pattern established by other packages**:
```javascript
const frontmatterMatch = content.match(/^---\s*\n([\s\S]*?)\n---/);
const fieldMatch = frontmatter.match(/^key:\s*["']?(.+?)["']?\s*$/m);
```

### R7: tcsetup Integration Points

**Decision**: Add knowledge-system to tcsetup's installer.js steps array and updater.js TOOLS array. Marker directory: `.knowledge/`. Skip flag: `--skip-knowledge`.

**Rationale**: Follows exact same pattern as the 5 existing tools. Minimal changes needed:
- `installer.js`: Add `{ name: "Knowledge System", flag: "--skip-knowledge", cmd: "npx @tcanaud/knowledge-system init" }`
- `updater.js`: Add `{ name: "Knowledge System", marker: ".knowledge", pkg: "@tcanaud/knowledge-system", cmd: "npx @tcanaud/knowledge-system update" }`
- `bin/cli.js`: Update help text

### R8: Guide YAML Frontmatter Schema

**Decision**: Guides use Markdown files with YAML frontmatter in `.knowledge/guides/`. Frontmatter contains: id, title, created, last_verified, references (conventions, adrs, features), watched_paths, topics.

**Rationale**: Matches the kai ecosystem pattern (ADRs use frontmatter, agreements use YAML). `watched_paths` mirrors the agreement watched_paths concept. `references` enables cross-system traceability. `topics` aids index routing.

**Schema**:
```yaml
---
id: release-package
title: How to release a package
created: "2026-02-18"
last_verified: "2026-02-18"
references:
  conventions: [conv-006-trusted-publishing]
  adrs: [20260218-esm-only-zero-deps]
  features: [005-tcsetup]
watched_paths:
  - .github/workflows/publish.yml
  - packages/*/package.json
topics: [release, npm, publish, package, deploy]
---
```
