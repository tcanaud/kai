# Data Model: 007-knowledge-system

**Date**: 2026-02-18
**Branch**: `007-knowledge-system`

## Entities

### Knowledge Guide

A Markdown file in `.knowledge/guides/<id>.md` with YAML frontmatter and prose content.

**Fields**:

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| id | string | yes | Unique slug identifier (e.g., `release-package`) |
| title | string | yes | Human-readable title |
| created | date (ISO) | yes | Creation date |
| last_verified | date (ISO) | yes | Last date freshness was confirmed |
| references.conventions | string[] | no | Convention IDs this guide relates to |
| references.adrs | string[] | no | ADR IDs this guide relates to |
| references.features | string[] | no | Feature IDs this guide relates to |
| watched_paths | string[] | no | File/directory paths to monitor for changes |
| topics | string[] | yes | Keywords/topics for index routing |

**Freshness states**:
- `verified` — all watched_paths unchanged since last_verified
- `stale` — one or more watched_paths modified after last_verified
- `unknown` — no watched_paths defined (freshness cannot be determined)

**Example**:
```yaml
---
id: release-package
title: How to release a package
created: "2026-02-18"
last_verified: "2026-02-18"
references:
  conventions: [conv-006-trusted-publishing]
  adrs: [20260218-esm-only-zero-deps]
  features: [005-tcsetup]
watched_paths:
  - packages/*/package.json
topics: [release, npm, publish, trusted-publishing]
---

## Steps

1. Bump version in package.json
2. Create git tag: `git tag vX.Y.Z`
3. Push tag: `git push --tags`
4. GitHub Actions publishes via OIDC trusted publishing
```

---

### Knowledge Index

A YAML file at `.knowledge/index.yaml`. Auto-generated by `refresh` command.

**Structure**:

| Section | Type | Description |
|---------|------|-------------|
| version | string | Schema version (e.g., "1.0") |
| generated | datetime (ISO) | When the index was last generated |
| guides[] | array | Catalog of all knowledge guides |
| conventions[] | array | Catalog of active conventions from `.agreements/` |
| adrs[] | array | Catalog of ADRs from `.adr/` |
| features[] | array | Catalog of features from `.features/` |

**Each entry has**:

| Field | Type | Description |
|-------|------|-------------|
| id | string | Unique identifier |
| title | string | Display title |
| path | string | Relative file path from project root |
| summary | string | One-line description for routing |
| topics | string[] | Keywords for relevance matching |
| status | string | Guide: verified/stale/unknown. ADR: accepted/deprecated. Feature: stage name. |

**Example**:
```yaml
version: "1.0"
generated: "2026-02-18T14:30:00Z"

guides:
  - id: release-package
    title: How to release a package
    path: .knowledge/guides/release-package.md
    summary: Step-by-step npm release via trusted publishing
    topics: [release, npm, publish, trusted-publishing]
    status: verified

conventions:
  - id: conv-001-esm-zero-deps
    title: ESM-only, zero runtime dependencies
    path: .agreements/conv-001-esm-zero-deps/agreement.yaml
    summary: All packages use Node.js ESM with zero runtime deps
    topics: [esm, dependencies, node, modules]

adrs:
  - id: 20260218-esm-only-zero-deps
    title: ESM-only with zero runtime dependencies
    path: .adr/global/20260218-esm-only-zero-deps.md
    summary: Decision to enforce ESM and zero runtime dependencies
    topics: [esm, dependencies, architecture]

features:
  - id: 005-tcsetup
    title: TC Setup bootstrapper
    path: .features/005-tcsetup/feature.yaml
    stage: release
    topics: [setup, bootstrap, onboarding, install]
```

---

### Knowledge Config

A YAML file at `.knowledge/config.yaml`. Created during init, user-editable.

**Fields**:

| Field | Type | Default | Description |
|-------|------|---------|-------------|
| version | string | "1.0" | Config schema version |
| freshness_threshold_days | number | 30 | Days after which unverified guide triggers warning |
| sources.agreements_dir | string | .agreements | Path to agreements directory |
| sources.adr_dir | string | .adr | Path to ADR directory |
| sources.features_dir | string | .features | Path to features directory |
| sources.specs_dir | string | specs | Path to specs directory |
| snapshot.include_conventions | boolean | true | Include conventions in snapshot |
| snapshot.include_adrs | boolean | true | Include ADRs in snapshot |
| snapshot.include_features | boolean | true | Include feature dashboard in snapshot |
| snapshot.include_tech_stack | boolean | true | Include tech stack summary in snapshot |

**Example**:
```yaml
version: "1.0"
freshness_threshold_days: 30

sources:
  agreements_dir: .agreements
  adr_dir: .adr
  features_dir: .features
  specs_dir: specs

snapshot:
  include_conventions: true
  include_adrs: true
  include_features: true
  include_tech_stack: true
```

---

### Knowledge Snapshot

An auto-generated Markdown file at `.knowledge/snapshot.md`. Regenerated by `refresh` command.

**Sections**:

| Section | Source | Description |
|---------|--------|-------------|
| Header | Generated | Title, generation timestamp |
| Active Conventions | `.agreements/conv-*` | Name + one-line summary per convention |
| Architecture Decisions | `.adr/` | Title + status per ADR |
| Feature Dashboard | `.features/` | Feature ID + title + stage per feature |
| Technology Stack | `package.json` + ADRs | Language, runtime, key constraints |

---

### Architecture Overview

A human-curated Markdown file at `.knowledge/architecture.md`. Created as scaffold during init, never auto-modified.

**Scaffold structure**:
```markdown
# Project Architecture

> This file is human-curated. The knowledge system will never auto-modify it.
> Update this when the project's macro architecture changes.

## Overview

[Describe what this project is and what it does]

## Systems

[List the major systems/packages and how they connect]

## Conventions

[Summarize the key conventions — or reference .knowledge/snapshot.md]

## Key Patterns

[Describe recurring patterns a newcomer should know]
```

---

## Relationships

```
config.yaml ──reads──→ scanners ──produce──→ index.yaml
                                              snapshot.md

guides/*.md ──scanned by──→ freshness checker ──outputs──→ check report (stdout)
     │
     └── watched_paths ──compared against──→ git log timestamps

/k command ──reads──→ index.yaml ──routes to──→ guides, ADRs, conventions
                                                    │
                                                    └── freshness status per source

.agreements/ ──scanned──→ conventions in index + snapshot
.adr/        ──scanned──→ ADRs in index + snapshot
.features/   ──scanned──→ features in index + snapshot
```

## File Layout

```
.knowledge/
├── config.yaml              # User-editable configuration
├── index.yaml               # Auto-generated knowledge catalog
├── architecture.md          # Human-curated macro overview
├── snapshot.md              # Auto-generated project state
└── guides/
    ├── release-package.md   # Example guide
    ├── add-feature.md       # Example guide
    └── debug-drift.md       # Example guide
```
